{"ast":null,"code":"/* eslint no-unused-vars: 0 */\nimport Tribute from \"src/decidim/vendor/tribute\";\n$(function () {\n  var $hashtagContainer = $(\".js-hashtags\");\n  var nodatafound = $hashtagContainer.attr(\"data-noresults\");\n  var noMatchTemplate = null;\n\n  if (nodatafound) {\n    noMatchTemplate = function noMatchTemplate() {\n      return \"<li>\".concat(nodatafound, \"</li>\");\n    };\n  } // Listener for the event triggered by quilljs\n\n\n  var cursor = \"\";\n  $hashtagContainer.on(\"quill-position\", function (event) {\n    if (event.detail !== null) {\n      // When replacing the text content after selecting a hashtag, we only need\n      // to know the hashtag's start position as that is the point which we want\n      // to replace.\n      var quill = event.target.__quill;\n\n      if (quill.getText(event.detail.index - 1, 1) === \"#\") {\n        cursor = event.detail.index;\n      }\n    }\n  });\n  /* eslint no-use-before-define: [\"error\", { \"variables\": false }]*/\n\n  var remoteSearch = function remoteSearch(text, cb) {\n    $.post(\"/api\", {\n      query: \"{hashtags(name:\\\"\".concat(text, \"\\\") {name}}\")\n    }).then(function (response) {\n      var data = response.data.hashtags || {};\n      cb(data);\n    }).fail(function () {\n      cb([]);\n    }).always(function () {\n      // This function runs Tribute every single time you type something\n      // So we must evalute DOM properties after each\n      var $parent = $(tribute.current.element).parent();\n      $parent.addClass(\"is-active\"); // We need to move the container to the wrapper selected\n\n      var $tribute = $parent.find(\".tribute-container\"); // Remove the inline styles, relative to absolute positioning\n\n      $tribute.removeAttr(\"style\");\n    });\n  }; // tribute.js docs - http://github.com/zurb/tribute\n\n  /* global Tribute*/\n\n\n  var tribute = new Tribute({\n    trigger: \"#\",\n    values: function values(text, cb) {\n      remoteSearch(text, function (hashtags) {\n        return cb(hashtags);\n      });\n    },\n    positionMenu: true,\n    menuContainer: null,\n    fillAttr: \"name\",\n    noMatchTemplate: noMatchTemplate,\n    lookup: function lookup(item) {\n      return item.name;\n    },\n    selectTemplate: function selectTemplate(item) {\n      if (typeof item === \"undefined\") {\n        return null;\n      }\n\n      if (this.range.isContentEditable(this.current.element)) {\n        // Check quill.js\n        if ($(this.current.element).hasClass(\"ql-editor\")) {\n          var editorContainer = $(this.current.element).parent().get(0);\n          var quill = editorContainer.__quill;\n          quill.insertText(cursor - 1, \"#\".concat(item.original.name, \" \"), Quill.sources.API); // cursor position + hashtag length + \"#\" sign + space\n\n          var position = cursor + item.original.name.length + 2;\n          var next = 0;\n\n          if (quill.getLength() > position) {\n            next = position;\n          } else {\n            next = quill.getLength() - 1;\n          } // Workaround https://github.com/quilljs/quill/issues/731\n\n\n          setTimeout(function () {\n            quill.setSelection(next, 0);\n          }, 500);\n          return \"\";\n        }\n\n        return \"<span contenteditable=\\\"false\\\">#\".concat(item.original.name, \"</span>\");\n      }\n\n      return \"#\".concat(item.original.name);\n    },\n    menuItemTemplate: function menuItemTemplate(item) {\n      var tpl = \"<strong>\".concat(item.original.name, \"</strong>\");\n      return tpl;\n    }\n  }); // Tribute needs to be attached to the `.ql-editor` element as said at:\n  // https://github.com/quilljs/quill/issues/1816\n  //\n  // For this reason we need to wait a bit for quill to initialize itself.\n\n  setTimeout(function () {\n    $hashtagContainer.each(function (index, item) {\n      var $qlEditor = $(\".ql-editor\", item);\n\n      if ($qlEditor.length > 0) {\n        tribute.attach($qlEditor);\n      } else {\n        tribute.attach(item);\n      }\n    });\n  }, 1000); // DOM manipulation\n\n  $hashtagContainer.on(\"focusin\", function (event) {\n    // Set the parent container relative to the current element\n    tribute.menuContainer = event.target.parentNode;\n  });\n  $hashtagContainer.on(\"focusout\", function (event) {\n    var $parent = $(event.target).parent();\n\n    if ($parent.hasClass(\"is-active\")) {\n      $parent.removeClass(\"is-active\");\n    }\n  });\n  $hashtagContainer.on(\"input\", function (event) {\n    var $parent = $(event.target).parent();\n\n    if (tribute.isActive) {\n      // We need to move the container to the wrapper selected\n      var $tribute = $(\".tribute-container\");\n      $tribute.appendTo($parent); // Parent adaptation\n\n      $parent.addClass(\"is-active\");\n    } else {\n      $parent.removeClass(\"is-active\");\n    }\n  });\n});","map":{"version":3,"mappings":"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","names":["Tribute","$","$hashtagContainer","nodatafound","attr","noMatchTemplate","cursor","on","event","detail","quill","target","__quill","getText","index","remoteSearch","text","cb","post","query","then","response","data","hashtags","fail","always","$parent","tribute","current","element","parent","addClass","$tribute","find","removeAttr","trigger","values","positionMenu","menuContainer","fillAttr","lookup","item","name","selectTemplate","range","isContentEditable","hasClass","editorContainer","get","insertText","original","Quill","sources","API","position","length","next","getLength","setTimeout","setSelection","menuItemTemplate","tpl","each","$qlEditor","attach","parentNode","removeClass","isActive","appendTo"],"sources":["/var/lib/gems/2.7.0/gems/decidim-core-0.26.0/app/packs/src/decidim/input_hashtags.js"],"sourcesContent":["/* eslint no-unused-vars: 0 */\nimport Tribute from \"src/decidim/vendor/tribute\"\n\n$(() => {\n  const $hashtagContainer = $(\".js-hashtags\");\n  const nodatafound = $hashtagContainer.attr(\"data-noresults\");\n\n  let noMatchTemplate = null\n  if (nodatafound) {\n    noMatchTemplate = () => `<li>${nodatafound}</li>`;\n  }\n\n  // Listener for the event triggered by quilljs\n  let cursor = \"\";\n  $hashtagContainer.on(\"quill-position\", function(event) {\n    if (event.detail !== null) {\n      // When replacing the text content after selecting a hashtag, we only need\n      // to know the hashtag's start position as that is the point which we want\n      // to replace.\n      let quill = event.target.__quill;\n      if (quill.getText(event.detail.index - 1, 1) === \"#\") {\n        cursor = event.detail.index;\n      }\n    }\n  });\n\n  /* eslint no-use-before-define: [\"error\", { \"variables\": false }]*/\n  let remoteSearch = function(text, cb) {\n    $.post(\"/api\", {query: `{hashtags(name:\"${text}\") {name}}`}).\n\n      then((response) => {\n        let data = response.data.hashtags || {};\n        cb(data)\n      }).fail(function() {\n        cb([])\n      }).always(() => {\n      // This function runs Tribute every single time you type something\n      // So we must evalute DOM properties after each\n        const $parent = $(tribute.current.element).parent()\n        $parent.addClass(\"is-active\")\n\n        // We need to move the container to the wrapper selected\n        const $tribute = $parent.find(\".tribute-container\");\n        // Remove the inline styles, relative to absolute positioning\n        $tribute.removeAttr(\"style\");\n      })\n  };\n\n  // tribute.js docs - http://github.com/zurb/tribute\n  /* global Tribute*/\n  let tribute = new Tribute({\n    trigger: \"#\",\n    values: function (text, cb) {\n      remoteSearch(text, (hashtags) => cb(hashtags));\n    },\n    positionMenu: true,\n    menuContainer: null,\n    fillAttr: \"name\",\n    noMatchTemplate: noMatchTemplate,\n    lookup: (item) => item.name,\n    selectTemplate: function(item) {\n      if (typeof item === \"undefined\") {\n        return null;\n      }\n      if (this.range.isContentEditable(this.current.element)) {\n        // Check quill.js\n        if ($(this.current.element).hasClass(\"ql-editor\")) {\n          let editorContainer = $(this.current.element).parent().get(0);\n          let quill = editorContainer.__quill;\n          quill.insertText(cursor - 1, `#${item.original.name} `, Quill.sources.API);\n          // cursor position + hashtag length + \"#\" sign + space\n          let position = cursor + item.original.name.length + 2;\n\n          let next = 0;\n          if (quill.getLength() > position) {\n            next = position\n          } else {\n            next = quill.getLength() - 1\n          }\n          // Workaround https://github.com/quilljs/quill/issues/731\n          setTimeout(function () {\n            quill.setSelection(next, 0);\n          }, 500);\n\n          return \"\"\n        }\n        return `<span contenteditable=\"false\">#${item.original.name}</span>`;\n      }\n      return `#${item.original.name}`;\n    },\n    menuItemTemplate: function(item) {\n      let tpl = `<strong>${item.original.name}</strong>`;\n      return tpl;\n    }\n  });\n\n  // Tribute needs to be attached to the `.ql-editor` element as said at:\n  // https://github.com/quilljs/quill/issues/1816\n  //\n  // For this reason we need to wait a bit for quill to initialize itself.\n  setTimeout(function() {\n    $hashtagContainer.each((index, item) => {\n      let $qlEditor = $(\".ql-editor\", item);\n      if ($qlEditor.length > 0) {\n        tribute.attach($qlEditor);\n      } else {\n        tribute.attach(item);\n      }\n    });\n  }, 1000);\n\n  // DOM manipulation\n  $hashtagContainer.on(\"focusin\", (event) => {\n    // Set the parent container relative to the current element\n\n    tribute.menuContainer = event.target.parentNode;\n  });\n  $hashtagContainer.on(\"focusout\", (event) => {\n    let $parent = $(event.target).parent();\n\n    if ($parent.hasClass(\"is-active\")) {\n      $parent.removeClass(\"is-active\");\n    }\n  });\n  $hashtagContainer.on(\"input\", (event) => {\n    let $parent = $(event.target).parent();\n\n    if (tribute.isActive) {\n      // We need to move the container to the wrapper selected\n      let $tribute = $(\".tribute-container\");\n      $tribute.appendTo($parent);\n      // Parent adaptation\n      $parent.addClass(\"is-active\");\n    } else {\n      $parent.removeClass(\"is-active\");\n    }\n  });\n});\n"]},"metadata":{},"sourceType":"module"}