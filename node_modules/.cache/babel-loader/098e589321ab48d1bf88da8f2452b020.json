{"ast":null,"code":"function _slicedToArray(arr, i) {\n  return _arrayWithHoles(arr) || _iterableToArrayLimit(arr, i) || _unsupportedIterableToArray(arr, i) || _nonIterableRest();\n}\n\nfunction _nonIterableRest() {\n  throw new TypeError(\"Invalid attempt to destructure non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.\");\n}\n\nfunction _unsupportedIterableToArray(o, minLen) {\n  if (!o) return;\n  if (typeof o === \"string\") return _arrayLikeToArray(o, minLen);\n  var n = Object.prototype.toString.call(o).slice(8, -1);\n  if (n === \"Object\" && o.constructor) n = o.constructor.name;\n  if (n === \"Map\" || n === \"Set\") return Array.from(o);\n  if (n === \"Arguments\" || /^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)) return _arrayLikeToArray(o, minLen);\n}\n\nfunction _arrayLikeToArray(arr, len) {\n  if (len == null || len > arr.length) len = arr.length;\n\n  for (var i = 0, arr2 = new Array(len); i < len; i++) {\n    arr2[i] = arr[i];\n  }\n\n  return arr2;\n}\n\nfunction _iterableToArrayLimit(arr, i) {\n  var _i = arr == null ? null : typeof Symbol !== \"undefined\" && arr[Symbol.iterator] || arr[\"@@iterator\"];\n\n  if (_i == null) return;\n  var _arr = [];\n  var _n = true;\n  var _d = false;\n\n  var _s, _e;\n\n  try {\n    for (_i = _i.call(arr); !(_n = (_s = _i.next()).done); _n = true) {\n      _arr.push(_s.value);\n\n      if (i && _arr.length === i) break;\n    }\n  } catch (err) {\n    _d = true;\n    _e = err;\n  } finally {\n    try {\n      if (!_n && _i[\"return\"] != null) _i[\"return\"]();\n    } finally {\n      if (_d) throw _e;\n    }\n  }\n\n  return _arr;\n}\n\nfunction _arrayWithHoles(arr) {\n  if (Array.isArray(arr)) return arr;\n}\n/* eslint-disable require-jsdoc */\n\n\nimport attributeDiff from \"src/decidim/editor/attribute_diff\";\nvar Delta = Quill[\"import\"](\"delta\");\n\nvar previousChar = function previousChar(quill, range) {\n  return quill.getText(range.index - 1, 1);\n};\n\nvar beforePreviousChar = function beforePreviousChar(quill, range) {\n  return quill.getText(range.index - 2, 1);\n};\n\nvar nextChar = function nextChar(quill, range) {\n  return quill.getText(range.index, 1);\n};\n\nvar handleListSelection = function handleListSelection(quill, range) {\n  var lastCharacterOfPreviousLine = quill.getText(range.index - 3, 1);\n\n  if (nextChar(quill, range) === \"\\n\" || lastCharacterOfPreviousLine !== \"\\n\") {\n    quill.setSelection(range.index - 1, Quill.sources.SILENT);\n  } else {\n    quill.setSelection(range.index - 3, Quill.sources.SILENT);\n  }\n};\n\nvar moveSelectionToPreviousLine = function moveSelectionToPreviousLine(quill, range) {\n  var lastCharacterOfPreviousLine = quill.getText(range.index - 3, 1);\n\n  if (nextChar(quill, range) === \"\\n\" || lastCharacterOfPreviousLine !== \"\\n\") {\n    quill.setSelection(range.index - 1, Quill.sources.SILENT);\n  } else {\n    quill.setSelection(range.index - 3, Quill.sources.SILENT);\n  }\n};\n\nexport default function backspaceBindings(quill) {\n  quill.keyboard.addBinding({\n    key: 8,\n    offset: 1,\n    collapsed: true\n  }, function (range, context) {\n    var length = 1;\n\n    if (/[\\uD800-\\uDBFF][\\uDC00-\\uDFFF]$/.test(context.prefix)) {\n      length = 2;\n    }\n\n    if (range.index === 0 || quill.getLength() <= 1) {\n      return;\n    }\n\n    var formats = {};\n\n    var _quill$getLine = quill.getLine(range.index),\n        _quill$getLine2 = _slicedToArray(_quill$getLine, 1),\n        line = _quill$getLine2[0];\n\n    var delta = new Delta().retain(range.index - length)[\"delete\"](length);\n\n    if (context.offset === 1 && previousChar(quill, range) === \"\\n\") {\n      var _quill$getLine3 = quill.getLine(range.index - 2),\n          _quill$getLine4 = _slicedToArray(_quill$getLine3, 1),\n          prev = _quill$getLine4[0];\n\n      if (prev && prev.statics.blotName === \"list-item\") {\n        formats = handleListSelection(quill, range);\n\n        if (prev !== null && prev.length() > 1) {\n          var curFormats = line.formats();\n          var prevFormats = quill.getFormat(range.index - 2, 1);\n          formats = attributeDiff(curFormats, prevFormats) || {};\n          length += 1;\n        }\n\n        delta = new Delta().retain(range.index - 2)[\"delete\"](2);\n        moveSelectionToPreviousLine(quill, range);\n      } else {\n        delta = new Delta().retain(range.index - 1)[\"delete\"](1);\n\n        if (range.index < 2) {\n          delta = new Delta()[\"delete\"](1).retain(range.index + line.length() - 1);\n        } else if (previousChar(quill, range) === \"\\n\" && beforePreviousChar(quill, range) === \"\\n\") {\n          delta = new Delta().retain(range.index - 2)[\"delete\"](2);\n        }\n      }\n    } else {\n      var _quill$getLine5 = quill.getLine(range.index - 1),\n          _quill$getLine6 = _slicedToArray(_quill$getLine5, 1),\n          _prev = _quill$getLine6[0];\n\n      if (_prev) {\n        var isPrevLineEmpty = _prev.statics.blotName === \"block\" && _prev.length() <= 1;\n\n        if (!isPrevLineEmpty) {\n          var _curFormats = line.formats();\n\n          var _prevFormats = quill.getFormat(range.index - 1, 1);\n\n          formats = attributeDiff(_curFormats, _prevFormats) || {};\n\n          if (Object.keys(formats).length > 0) {\n            // line.length() - 1 targets \\n in line, another -1 for newline being deleted\n            var formatDelta = new Delta().retain(range.index + line.length() - 2).retain(1, formats);\n            delta = delta.compose(formatDelta);\n          }\n        }\n      }\n    }\n\n    quill.updateContents(delta, Quill.sources.USER);\n\n    if (Object.keys(formats).length > 0) {\n      quill.formatLine(range.index - length, length, formats, Quill.sources.USER);\n    }\n\n    quill.focus();\n  }); // Put this backspace binding to second\n\n  quill.keyboard.bindings[8].splice(1, 0, quill.keyboard.bindings[8].pop());\n}","map":{"version":3,"mappings":"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","names":["attributeDiff","Delta","Quill","previousChar","quill","range","getText","index","beforePreviousChar","nextChar","handleListSelection","lastCharacterOfPreviousLine","setSelection","sources","SILENT","moveSelectionToPreviousLine","backspaceBindings","keyboard","addBinding","key","offset","collapsed","context","length","test","prefix","getLength","formats","getLine","line","delta","retain","prev","statics","blotName","curFormats","prevFormats","getFormat","isPrevLineEmpty","Object","keys","formatDelta","compose","updateContents","USER","formatLine","focus","bindings","splice","pop"],"sources":["/var/lib/gems/2.7.0/gems/decidim-core-0.26.0/app/packs/src/decidim/editor/modified_backspace_offset1.js"],"sourcesContent":["/* eslint-disable require-jsdoc */\n\nimport attributeDiff from \"src/decidim/editor/attribute_diff\"\n\nconst Delta = Quill.import(\"delta\");\n\nconst previousChar = (quill, range) => {\n  return quill.getText(range.index - 1, 1);\n}\n\nconst beforePreviousChar = (quill, range) => {\n  return quill.getText(range.index - 2, 1);\n}\n\nconst nextChar = (quill, range) => {\n  return quill.getText(range.index, 1);\n}\n\nconst handleListSelection = (quill, range) => {\n  const lastCharacterOfPreviousLine = quill.getText(range.index - 3, 1);\n  if (nextChar(quill, range) === \"\\n\" || lastCharacterOfPreviousLine !== \"\\n\") {\n    quill.setSelection(range.index - 1, Quill.sources.SILENT);\n  } else {\n    quill.setSelection(range.index - 3, Quill.sources.SILENT);\n  }\n}\n\nconst moveSelectionToPreviousLine = (quill, range) => {\n  const lastCharacterOfPreviousLine = quill.getText(range.index - 3, 1);\n  if (nextChar(quill, range) === \"\\n\" || lastCharacterOfPreviousLine !== \"\\n\") {\n    quill.setSelection(range.index - 1, Quill.sources.SILENT);\n  } else {\n    quill.setSelection(range.index - 3, Quill.sources.SILENT);\n  }\n}\n\nexport default function backspaceBindings(quill) {\n  quill.keyboard.addBinding({ key: 8, offset: 1, collapsed: true }, (range, context) => {\n    let length = 1\n    if ((/[\\uD800-\\uDBFF][\\uDC00-\\uDFFF]$/).test(context.prefix)) {\n      length = 2;\n    }\n\n    if (range.index === 0 || quill.getLength() <= 1) {\n      return;\n    }\n    let formats = {};\n    const [line] = quill.getLine(range.index);\n    let delta = new Delta().retain(range.index - length).delete(length);\n    if (context.offset === 1 && previousChar(quill, range) === \"\\n\") {\n      const [prev] = quill.getLine(range.index - 2);\n      if (prev && prev.statics.blotName === \"list-item\") {\n        formats = handleListSelection(quill, range);\n        if (prev !== null && prev.length() > 1) {\n          let curFormats = line.formats();\n          let prevFormats = quill.getFormat(range.index - 2, 1);\n          formats = attributeDiff(curFormats, prevFormats) || {};\n          length += 1;\n        }\n        delta = new Delta().retain(range.index - 2).delete(2);\n        moveSelectionToPreviousLine(quill, range);\n      } else {\n        delta = new Delta().retain(range.index - 1).delete(1);\n        if (range.index < 2) {\n          delta = new Delta().delete(1).retain(range.index + line.length() - 1);\n        } else if (previousChar(quill, range) === \"\\n\" && beforePreviousChar(quill, range) === \"\\n\") {\n          delta = new Delta().retain(range.index - 2).delete(2);\n        }\n      }\n    } else {\n      const [prev] = quill.getLine(range.index - 1);\n      if (prev) {\n        const isPrevLineEmpty =\n          prev.statics.blotName === \"block\" && prev.length() <= 1;\n        if (!isPrevLineEmpty) {\n          const curFormats = line.formats();\n          const prevFormats = quill.getFormat(range.index - 1, 1);\n          formats = attributeDiff(curFormats, prevFormats) || {};\n          if (Object.keys(formats).length > 0) {\n            // line.length() - 1 targets \\n in line, another -1 for newline being deleted\n            const formatDelta = new Delta().retain(range.index + line.length() - 2).retain(1, formats);\n            delta = delta.compose(formatDelta);\n          }\n        }\n      }\n    }\n    quill.updateContents(delta, Quill.sources.USER);\n    if (Object.keys(formats).length > 0) {\n      quill.formatLine(range.index - length, length, formats, Quill.sources.USER);\n    }\n    quill.focus();\n  });\n\n  // Put this backspace binding to second\n  quill.keyboard.bindings[8].splice(1, 0, quill.keyboard.bindings[8].pop());\n}\n"]},"metadata":{},"sourceType":"module"}